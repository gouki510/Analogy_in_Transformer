services:
  emergent-analogy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: emergent-analogy
    shm_size: '8gb'
    volumes:
      - ./data:/app/data
      - ./runs:/app/runs
      - ./configs:/app/configs
    environment:
      - WANDB_API_KEY=${WANDB_API_KEY:-}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
    # GPU support
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    working_dir: /app/src
    stdin_open: true
    tty: true

  # Service for generating data
  generate-data:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./data:/app/data
      - ./configs:/app/configs
    working_dir: /app/src
    command: python generate_data.py --config /app/configs/default.yaml

  # Service for training
  train:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./data:/app/data
      - ./runs:/app/runs
      - ./configs:/app/configs
    environment:
      - WANDB_API_KEY=${WANDB_API_KEY:-}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    working_dir: /app/src
    command: python train.py --config /app/configs/default.yaml

  # CPU-only training service (for machines without GPU)
  train-cpu:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./data:/app/data
      - ./runs:/app/runs
      - ./configs:/app/configs
    environment:
      - WANDB_API_KEY=${WANDB_API_KEY:-}
      - CUDA_VISIBLE_DEVICES=-1
    working_dir: /app/src
    command: python train.py --config /app/configs/default.yaml
